{% extends "./base2.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-evenly">
    <!-- Product Image Section -->
    <div class="col-lg-5 mb-4 mb-lg-0" style="max-width: 375px; height: auto;">
      <div class="rounded overflow-hidden shadow-sm">
        <img src="{{ product.image.url }}" alt="{{ product.title }}" class="img-fluid rounded">
      </div>
    </div>

    <!-- Modal Structure -->
    <div class="modal fade" id="sizeChartModal" tabindex="-1" aria-labelledby="sizeChartModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sizeChartModalLabel">Size Charts</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <!-- Dynamically Render the Size Chart Image -->
            <img src="{% static size_chart_image %}" alt="Size Chart" class="img-fluid rounded">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Product Details Section -->
    <div class="col-lg-6">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">{{ product.title }}</h1>
        <button 
          type="button" 
          id="wishlist-button" 
          class="btn btn-outline-secondary rounded-circle p-2"
          data-product-id="{{ product.id }}"
          data-in-wishlist="{{ has_wishlist|yesno:"true,false" }}"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="0.5" class="bi bi-heart-fill heart-icon" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
          </svg>
        </button>
      </div>

      <p class="lead mb-4">{{ product.description }}</p>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="h5 mb-0">Price</span>
            <span class="h3 mb-0 fw-bold text-primary">$ {{ product.price }}</span>
          </div>
          <div class="mb-3">
            <label class="form-label">Size</label>
            <div class="btn-group" role="group" aria-label="Size selection">
              <input type="radio" class="btn-check" name="size" id="size-s" value="S" autocomplete="off">
              <label class="btn btn-outline-primary" for="size-s">S</label>

              <input type="radio" class="btn-check" name="size" id="size-m" value="M" autocomplete="off">
              <label class="btn btn-outline-primary" for="size-m">M</label>

              <input type="radio" class="btn-check" name="size" id="size-l" value="L" autocomplete="off">
              <label class="btn btn-outline-primary" for="size-l">L</label>

              <input type="radio" class="btn-check" name="size" id="size-xl" value="XL" autocomplete="off">
              <label class="btn btn-outline-primary" for="size-xl">XL</label>
            </div>

            {% if size_chart_image %}
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#sizeChartModal">
                Size Chart
              </button>
            {% endif %}
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <label for="select" class="me-2">Qty</label>
              <select id="select" class="form-select" style="width: auto;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
              </select>
            </div>
            <button
              type="button"
              id="add-button"
              value="{{ product.id }}"
              class="btn btn-primary"
            >
              Add to cart
            </button>
          </div>
        </div>
      </div>

      {% if show_care_instructions %}
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Material & Care</h5>
            <p class="mb-2">100% Cotton</p>
            <ul class="list-unstyled">
              <li><small>• Machine or handwash up to 30°C/86F</small></li>
              <li><small>• Gentle cycle</small></li>
              <li><small>• Do not dry in direct sunlight</small></li>
              <li><small>• Do not bleach</small></li>
              <li><small>• Do not iron directly on prints/embroidery</small></li>
            </ul>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Reviews Section -->
  <section class="mt-5">
    <h2 class="h3 mb-4">Customer Reviews</h2>
    <div class="row">
      {% if reviews %}
        {% for review in reviews %}
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-bold">{{ review.user }}</span>
                  <div>
                    {% for i in "12345" %}
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" stroke="black" stroke-width="0.3" class="bi bi-star-fill {% if forloop.counter <= review.rating %}text-warning{% else %}text-white{% endif %}" viewBox="0 0 16 16">
                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                      </svg>
                    {% endfor %}
                  </div>
                </div>
                <p class="card-text text-black">{{ review.content }}</p>
                {% if review.image %}
                  <img src="{{ review.image.url }}" alt="Review image" class="img-fluid rounded mb-2 review-posted-image">
                {% endif %}
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <small class="text-muted">{{ review.date_added|date:"F d, Y" }}</small>
                  {% if user == review.user %}
                    <button class="delete-review-btn btn btn-danger btn-sm" data-id="{{ review.id }}">Delete</button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col">
          <p class="text-center">No reviews yet.</p>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- Add Review Form -->
  {% if user.is_authenticated and has_purchased and not has_commented %}
  <section class="mt-5">
    <h2 class="h3 mb-4">Add a Review</h2>
    <form action="{% url 'product-info' product.slug %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="mb-3">
        <label for="rating" class="form-label">Rating</label>
        <div>
          <input type="hidden" name="rating" id="rating" value="0">
          {% for i in "12345" %}
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" stroke="black" stroke-width="1" class="bi bi-star-fill star-rating text-white" data-rating="{{ forloop.counter }}"  viewBox="0 0 16 16">
              <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
            </svg>
          {% endfor %}
        </div>
      </div>
      <div class="mb-3">
        <label for="content" class="form-label">Review</label>
        <textarea id="content" name="content" rows="4" required class="form-control"></textarea>
      </div>
      <div class="mb-3">
        <label for="image" class="form-label">Image (optional)</label>
        <input type="file" id="image" name="image" accept="image/*" class="form-control">
      </div>
      <button type="submit" class="btn btn-primary">Submit Review</button>
    </form>
  </section>
  {% endif %}
</div>

{% if messages %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      {% for message in messages %}
        showToast("{{ message|escapejs }}", "{{ message.tags|default:'primary' }}");
      {% endfor %}
    });
  </script>
{% endif %}

<script>
  function updateCart(response) {
    // Update cart quantity
    $('#cart-qty2').text(response.qty);
    
    // Update cart total
    console.log('Before update:', $('#cart-total').text());
    const formattedTotal = `$${response.total.toFixed(2)}`;
    $('#cart-total').text(formattedTotal);
    console.log('After update:', $('#cart-total').text());

    // Clear existing cart items
    const cartList = $('.list-group.mb-3');
    cartList.empty();
    console.log('Cleared cart list.');

    // Populate cart items from response
    response.items.forEach(item => {
        console.log('Adding item:', item);
        console.log('Processing Item:', item);
        console.log('Item total:', item.total, typeof item.total);
        console.log('Item qty:', item.qty, typeof item.qty);
        console.log('Response total:', response.total, typeof response.total);
        cartList.append(`
            <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                    <h6 class="my-0">${item.title}</h6>
                    <p class="my-0">Quantity: ${item.qty}</p>
                    <p class="my-0">Size: ${item.size}</p>
                    <small class="text-body-secondary">${item.description}</small>
                </div>
                <span class="text-body-secondary">$${item.total}</span>
            </li>
        `);
    });
}

// Add to cart functionality
$(document).on('click', '#add-button', function(e) {
    e.preventDefault();
    console.log('Add to cart button clicked');

    // Get the selected size
    const selectedSize = $('input[name="size"]:checked').val();
    if (!selectedSize) {
        showToast('Please select a size before adding to the cart.', 'error');
        return; // Stop execution if no size is selected
    }

    $.ajax({
        type: 'POST',
        url: '{% url "cart-add" %}',
        data: {
            product_id: $('#add-button').val(),
            product_quantity: $('#select option:selected').text(),
            product_size: selectedSize, // Add the size to the request
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'post',
        },
        success: function(response) {
            updateCart(response);
            showToast('Product added to cart', 'success');
        },
        error: function(xhr, errmsg, err) {
            console.log('Error adding to cart:', errmsg);
            // Handle error
        }
    });
});

  // Image preview
  const imageInput = document.getElementById('image');
  const imagePreview = document.createElement('img');
  imagePreview.classList.add('mt-2', 'img-fluid', 'rounded', 'd-none', 'review-image-preview');
  imageInput.parentNode.insertBefore(imagePreview, imageInput.nextSibling);

  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.classList.remove('d-none');
      }
      reader.readAsDataURL(file);
    } else {
      imagePreview.classList.add('d-none');
    }
  });
</script>
<script>
  // Delete Review
  $(document).on('click', '.delete-review-btn', function() {
    console.log('Delete review button clicked');
    const reviewId = $(this).data('id');
  
    $.ajax({
      url: `/delete-review/${reviewId}/`,
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function(data) {
        location.reload();
      },
      error: function(error) {
        console.error(error);
      }
    });
  });
</script>
<script>
  // Star rating system
  const stars = document.querySelectorAll('.star-rating');
  const ratingInput = document.getElementById('rating');
  let currentRating = 0;

  stars.forEach(star => {
    star.addEventListener('mouseover', () => {
      const rating = parseInt(star.dataset.rating);
      highlightStars(rating);
    });

    star.addEventListener('mouseout', () => {
      highlightStars(currentRating);
    });

    star.addEventListener('click', () => {
      currentRating = parseInt(star.dataset.rating);
      ratingInput.value = currentRating;
      highlightStars(currentRating);
    });
  });

  function highlightStars(rating) {
    stars.forEach(star => {
      const starRating = parseInt(star.dataset.rating);
      if (starRating <= rating) {
        star.classList.remove('text-white');
        star.classList.add('text-warning');
      } else {
        star.classList.remove('text-warning');
        star.classList.add('text-white');
      }
    });
  }
</script>
<script>
  // Wishlist functionality
  document.addEventListener('DOMContentLoaded', function() {
    const wishlistButton = document.getElementById('wishlist-button');
    const heartIcon = wishlistButton.querySelector('.heart-icon');
    
    function updateHeartIcon(inWishlist) {
      if (inWishlist) {
        heartIcon.classList.add('text-danger');
        heartIcon.classList.remove('text-white');
        heartIcon.setAttribute('stroke', 'none');
        console.log('Heart icon updated to red in product-info.html code.');
      } else {
        heartIcon.classList.remove('text-danger');
        heartIcon.classList.add('text-white');
        heartIcon.setAttribute('stroke', 'black');
        console.log('Heart icon updated to white in product-info.html code.');
      }
    }

    // Set initial state using the has_wishlist variable
    updateHeartIcon(wishlistButton.dataset.inWishlist === 'true');

    wishlistButton.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Wishlist button clicked from product-info.html');

      const productId = this.dataset.productId;
      const currentState = this.dataset.inWishlist === 'true';

      // Toggle the state immediately for responsive UI
      this.dataset.inWishlist = (!currentState).toString();

      updateHeartIcon(!currentState);

      // Send AJAX request to update server
      $.ajax({
        type: 'POST',
        url: '{% url "toggle-wishlist" %}',
        data: {
          product_id: productId,
          csrfmiddlewaretoken: '{{ csrf_token }}',
          action: 'post',
        },
        success: function(response) {
          // Update the UI based on the server response
          console.log('Wishlist response from product-info.html:', response);
          const newState = response.action === 'added';
          wishlistButton.dataset.inWishlist = newState.toString();
          updateHeartIcon(newState);

          if (newState) {
            showToast('Product added to wishlist', 'success');
          } else {
            showToast('Product removed from wishlist', 'info');
          }
        },
        error: function(xhr, errmsg, err) {
          // Revert the UI state in case of an error
          wishlistButton.dataset.inWishlist = currentState.toString();
          updateHeartIcon(currentState);
          console.error('Error toggling wishlist:', errmsg);
        }
      });
    });
  });
</script>
{% endblock %}